name: SonarQube Analysis

on:
  push:
    branches:
    - main
  pull_request:
    types: [ opened, synchronize, reopened ]

env:
  # --- GLOBAL CONFIGURATION ---
  BACKEND_REQUIRED_COVERAGE: 16 # Set back to your threshold (e.g., 16 or 80)
  FRONTEND_REQUIRED_COVERAGE: 80 

jobs:
  frontend-sonarqube:
    name: Frontend SonarQube
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Install dependencies
      run: yarn
      working-directory: swapstreet

    - name: Run tests and collect coverage (Jest)
      run: |
        yarn jest --coverage --coverageThreshold='{
          "global": {
            "branches": ${{ env.FRONTEND_REQUIRED_COVERAGE }},
            "functions": ${{ env.FRONTEND_REQUIRED_COVERAGE }},
            "lines": ${{ env.FRONTEND_REQUIRED_COVERAGE }},
            "statements": ${{ env.FRONTEND_REQUIRED_COVERAGE }}
          }
        }'
      working-directory: swapstreet

    - name: Verify coverage file
      run: |
        ls -l coverage
        cat coverage/lcov.info | head -n 20
      working-directory: swapstreet

    - name: SonarQube Scan
      uses: SonarSource/sonarqube-scan-action@v6
      env:
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      with:
        projectBaseDir: swapstreet
        args: >
          -Dsonar.projectKey=swapstreet -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info

    - name: Wait for SonarQube Quality Gate result
      uses: SonarSource/sonarqube-quality-gate-action@v1.1.0
      env:
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      with:
        scanMetadataReportFile: swapstreet/.scannerwork/report-task.txt

  backend-sonarqube:
    name: Backend SonarQube
    runs-on: windows-latest
    needs: frontend-sonarqube
    steps:
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: 17
        distribution: 'zulu'

    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Cache SonarQube Cloud packages
      uses: actions/cache@v4
      with:
        path: ~\sonar\cache
        key: ${{ runner.os }}-sonar
        restore-keys: ${{ runner.os }}-sonar

    - name: Cache SonarQube Cloud scanner
      id: cache-sonar-scanner
      uses: actions/cache@v4
      with:
        path: ${{ runner.temp }}\scanner
        key: ${{ runner.os }}-sonar-scanner
        restore-keys: ${{ runner.os }}-sonar-scanner

    - name: Install SonarQube Cloud scanner
      if: steps.cache-sonar-scanner.outputs.cache-hit != 'true'
      shell: powershell
      run: |
        New-Item -Path ${{ runner.temp }}\scanner -ItemType Directory
        dotnet tool update dotnet-sonarscanner --tool-path ${{ runner.temp }}\scanner

    - name: Install dotnet-coverage
      run: dotnet tool install --global dotnet-coverage

    - name: Begin SonarQube analysis
      env:
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      shell: powershell
      working-directory: backend
      run: |
        ${{ runner.temp }}\scanner\dotnet-sonarscanner begin `
          /k:"swapstreet" `
          /o:"swapstreet" `
          /d:sonar.token="${{ secrets.SONAR_TOKEN }}" `
          /d:sonar.cs.vscoveragexml.reportsPaths=coverage.xml `
          /d:sonar.coverage.exclusions="**/Migrations/**,**/Models/**"

    - name: Build backend
      shell: powershell
      working-directory: backend
      run: dotnet build --no-incremental

    # --------------------------------------------------------
    # CRITICAL SECTION: UPDATED PARSING LOGIC
    # --------------------------------------------------------
    - name: Run tests and collect coverage
      shell: pwsh
      working-directory: backend
      run: |
        dotnet-coverage collect "dotnet test --no-build" -f xml -o "coverage.xml"

        if (!(Test-Path "coverage.xml")) {
          Write-Error "coverage.xml not found!"
          exit 1
        }
        Write-Host "‚úÖ coverage.xml file generated."

    - name: Enforce Coverage Threshold
      shell: pwsh
      working-directory: backend
      run: |
        $requiredCoverage = [double]${{ env.BACKEND_REQUIRED_COVERAGE }}
        Write-Host "--- Enforcing Minimum Coverage: $requiredCoverage% ---"

        [xml]$cov = Get-Content "coverage.xml"
        
        # FIX: Get all modules first
        $allModules = $cov.results.modules.module

        # DEBUG: Print all modules found to see what is dragging the score down
        Write-Host "üîç Modules found in coverage report:"
        foreach ($m in $allModules) {
            Write-Host "   - $($m.name): $($m.line_coverage)%"
        }

        # FIX: Specifically select 'backend.dll' to ignore test projects/dependencies
        $module = $allModules | Where-Object { $_.name -eq "backend.dll" }

        if (-not $module) {
          Write-Error "‚ùå Could not find 'backend.dll' in coverage.xml."
          exit 1
        }

        $lineCoverage = [double]$module.line_coverage
        Write-Host "‚û° TARGET Backend test coverage: $lineCoverage%"

        if ($lineCoverage -lt $requiredCoverage) {
          Write-Error "FAILURE: Coverage below $requiredCoverage% ($lineCoverage%)"
          exit 1 
        } else {
          Write-Host "SUCCESS: Coverage $lineCoverage% meets or exceeds $requiredCoverage%."
        }
    # --------------------------------------------------------

    - name: End SonarQube analysis
      env:
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      shell: powershell
      working-directory: backend
      run: |
        ${{ runner.temp }}\scanner\dotnet-sonarscanner end /d:sonar.token="${{ secrets.SONAR_TOKEN }}"