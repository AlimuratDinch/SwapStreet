name: SonarQube Analysis

on:
  push:
    branches:
    - main
  pull_request:
    types: [ opened, synchronize, reopened ]

jobs:
  frontend-sonarqube:
    name: Frontend SonarQube
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Install dependencies
      run: yarn
      working-directory: swapstreet

    - name: Run tests and collect coverage with threshold
      run: |
        yarn jest --coverage --coverageThreshold='{
          "global": {
            "branches": 80,
            "functions": 80,
            "lines": 80,
            "statements": 80
          }
        }'
      working-directory: swapstreet

    - name: Verify coverage file
      run: |
        ls -l coverage
        cat coverage/lcov.info | head -n 20
      working-directory: swapstreet

    - name: SonarQube Scan
      uses: SonarSource/sonarqube-scan-action@v6
      env:
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      with:
        projectBaseDir: swapstreet
        args: >
          -Dsonar.projectKey=swapstreet -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info

    - name: Wait for SonarQube Quality Gate result
      uses: SonarSource/sonarqube-quality-gate-action@v1.1.0
      env:
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      with:
        scanMetadataReportFile: swapstreet/.scannerwork/report-task.txt
  
  backend-sonarqube:
  name: Backend SonarQube
  runs-on: ubuntu-latest
  needs: frontend-sonarqube
  steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: 17
        distribution: 'zulu'

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'

    - name: Install SonarScanner for .NET
      shell: pwsh
      run: |
        New-Item -Path "${{ runner.temp }}/scanner" -ItemType Directory -Force
        dotnet tool update dotnet-sonarscanner --tool-path "${{ runner.temp }}/scanner"

    - name: Install dotnet-coverage
      shell: pwsh
      run: dotnet tool install --global dotnet-coverage

    - name: Begin SonarQube analysis
      shell: pwsh
      working-directory: backend
      env:
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      run: |
        ${{ runner.temp }}/scanner/dotnet-sonarscanner begin `
          /k:"swapstreet" `
          /o:"swapstreet" `
          /d:sonar.token="${{ secrets.SONAR_TOKEN }}" `
          /d:sonar.cs.vscoveragexml.reportsPaths=coverage.xml `
          /d:sonar.coverage.exclusions="**/Migrations/**,**/Models/**"

    - name: Build backend
      shell: pwsh
      working-directory: backend
      run: dotnet build --no-incremental

    - name: Pull Postgres image (for Testcontainers)
      run: docker pull postgres:15

    - name: Run tests + coverage
      shell: pwsh
      working-directory: backend
      run: |
        dotnet-coverage collect "dotnet test --no-build" -f xml -o "coverage.xml" -s "coverage.settings.xml"

    - name: End SonarQube analysis
      shell: pwsh
      working-directory: backend
      env:
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      run: |
        ${{ runner.temp }}/scanner/dotnet-sonarscanner end /d:sonar.token="${{ secrets.SONAR_TOKEN }}"
